From a0e495c5cee073e0a29450c58f3cdf1b183a7ed3 Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <nathan@kernel.org>
Date: Fri, 6 Oct 2023 10:58:42 -0700
Subject: [PATCH 9/9] HACK: LONGTERM: bcachefs: Workaround clang builtin error

Link: https://github.com/ClangBuiltLinux/linux/issues/1932
Signed-off-by: Nathan Chancellor <nathan@kernel.org>
---
 fs/bcachefs/replicas.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/fs/bcachefs/replicas.c b/fs/bcachefs/replicas.c
index 2008fe8bf706..61072b01ea62 100644
--- a/fs/bcachefs/replicas.c
+++ b/fs/bcachefs/replicas.c
@@ -33,7 +33,9 @@ void bch2_replicas_entry_sort(struct bch_replicas_entry *e)
 
 static void bch2_cpu_replicas_sort(struct bch_replicas_cpu *r)
 {
+#if !defined(CONFIG_X86_32) || defined(CONFIG_FORTIFY_SOURCE)
 	eytzinger0_sort(r->entries, r->nr, r->entry_size, memcmp, NULL);
+#endif
 }
 
 static void bch2_replicas_entry_v0_to_text(struct printbuf *out,
@@ -830,10 +832,12 @@ static int bch2_cpu_replicas_validate(struct bch_replicas_cpu *cpu_r,
 {
 	unsigned i;
 
+#if !defined(CONFIG_X86_32) || defined(CONFIG_FORTIFY_SOURCE)
 	sort_cmp_size(cpu_r->entries,
 		      cpu_r->nr,
 		      cpu_r->entry_size,
 		      memcmp, NULL);
+#endif
 
 	for (i = 0; i < cpu_r->nr; i++) {
 		struct bch_replicas_entry *e =
-- 
2.43.0

