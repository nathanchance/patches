From c62f39f7954027fdbae3df399422f59010367078 Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <nathan@kernel.org>
Date: Tue, 27 Sep 2022 13:27:30 -0700
Subject: [PATCH 1/9] NOTCBL: FROMLIST: v4 + fix -> v5 of "mm/hwpoison:
 introduce per-memory_block hwpoison counter counter"

Link: https://lore.kernel.org/20220923141204.GA1484969@ik1-406-35019.vs.sakura.ne.jp/
Signed-off-by: Nathan Chancellor <nathan@kernel.org>
---
 drivers/base/memory.c  |  9 +--------
 include/linux/memory.h |  2 +-
 include/linux/mm.h     | 20 ++++++++++++++++++--
 3 files changed, 20 insertions(+), 11 deletions(-)

diff --git a/drivers/base/memory.c b/drivers/base/memory.c
index f470bbfc68d0..99e0e789616c 100644
--- a/drivers/base/memory.c
+++ b/drivers/base/memory.c
@@ -1169,8 +1169,7 @@ int walk_dynamic_memory_groups(int nid, walk_memory_groups_func_t func,
 	return ret;
 }
 
-#ifdef CONFIG_MEMORY_FAILURE
-
+#if defined(CONFIG_MEMORY_FAILURE) && defined(CONFIG_MEMORY_HOTPLUG)
 void memblk_nr_poison_inc(unsigned long pfn)
 {
 	const unsigned long block_id = pfn_to_block_id(pfn);
@@ -1198,10 +1197,4 @@ unsigned long memblk_nr_poison(unsigned long pfn)
 		return atomic_long_read(&mem->nr_hwpoison);
 	return 0;
 }
-
-#else
-unsigned long memblk_nr_poison(unsigned long pfn)
-{
-	return 0;
-}
 #endif
diff --git a/include/linux/memory.h b/include/linux/memory.h
index 74e6b3ad947f..ad8cd9bb3239 100644
--- a/include/linux/memory.h
+++ b/include/linux/memory.h
@@ -85,7 +85,7 @@ struct memory_block {
 	unsigned long nr_vmemmap_pages;
 	struct memory_group *group;	/* group (if any) for this block */
 	struct list_head group_next;	/* next block inside memory group */
-#ifdef CONFIG_MEMORY_FAILURE
+#if defined(CONFIG_MEMORY_FAILURE) && defined(CONFIG_MEMORY_HOTPLUG)
 	atomic_long_t nr_hwpoison;
 #endif
 };
diff --git a/include/linux/mm.h b/include/linux/mm.h
index 5445943bbb4b..936864d6f8be 100644
--- a/include/linux/mm.h
+++ b/include/linux/mm.h
@@ -3280,8 +3280,6 @@ extern int soft_offline_page(unsigned long pfn, int flags);
 #ifdef CONFIG_MEMORY_FAILURE
 extern int __get_huge_page_for_hwpoison(unsigned long pfn, int flags);
 extern void num_poisoned_pages_inc(unsigned long pfn);
-extern void memblk_nr_poison_inc(unsigned long pfn);
-extern void memblk_nr_poison_sub(unsigned long pfn, long i);
 extern void clear_hwpoisoned_pages(long nr_poison);
 #else
 static inline int __get_huge_page_for_hwpoison(unsigned long pfn, int flags)
@@ -3297,7 +3295,25 @@ static inline void clear_hwpoisoned_pages(long nr_poison)
 {
 }
 #endif
+
+#if defined(CONFIG_MEMORY_FAILURE) && defined(CONFIG_MEMORY_HOTPLUG)
+extern void memblk_nr_poison_inc(unsigned long pfn);
+extern void memblk_nr_poison_sub(unsigned long pfn, long i);
 extern unsigned long memblk_nr_poison(unsigned long pfn);
+#else
+static inline void memblk_nr_poison_inc(unsigned long pfn)
+{
+}
+
+static inline void memblk_nr_poison_sub(unsigned long pfn, long i)
+{
+}
+
+static inline unsigned long memblk_nr_poison(unsigned long pfn)
+{
+	return 0;
+}
+#endif
 
 #ifndef arch_memory_failure
 static inline int arch_memory_failure(unsigned long pfn, int flags)

base-commit: 1bd8b75fe6adeaa89d02968bdd811ffe708cf839
-- 
2.37.3

