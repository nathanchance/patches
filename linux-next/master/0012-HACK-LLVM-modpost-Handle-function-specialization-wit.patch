From 8757005fa319ec211208f4bf605169c8170ff0de Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <nathan@kernel.org>
Date: Tue, 25 Apr 2023 09:51:13 -0700
Subject: [PATCH 12/12] HACK: LLVM: modpost: Handle function specialization
 with LLVM LTO

Link: https://github.com/ClangBuiltLinux/linux/issues/1838
Signed-off-by: Nathan Chancellor <nathan@kernel.org>
---
 scripts/mod/modpost.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/scripts/mod/modpost.c b/scripts/mod/modpost.c
index d4531d09984d..4798239856f3 100644
--- a/scripts/mod/modpost.c
+++ b/scripts/mod/modpost.c
@@ -847,6 +847,8 @@ static const char *const init_sections[] = { ALL_INIT_SECTIONS, NULL };
 
 /* all text sections */
 static const char *const text_sections[] = { ALL_TEXT_SECTIONS, NULL };
+static const char *const llvm_specialized_text_sections[] =
+	{ ".text.*.[0-9]", ".text.*.[0-9][0-9]", NULL };
 
 /* data section */
 static const char *const data_sections[] = { DATA_SECTIONS, NULL };
@@ -1110,6 +1112,10 @@ static int secref_whitelist(const struct sectioncheck *mismatch,
 	if (strstarts(fromsym, ".L"))
 		return 0;
 
+	if (match(fromsec, llvm_specialized_text_sections) &&
+	    match(tosec, init_sections))
+		return 0;
+
 	return 1;
 }
 
-- 
2.40.1

